import os
import pandas as pd
import numpy as np
import faiss
from sentence_transformers import SentenceTransformer

# تنظیمات مسیرها
EMBEDDINGS_DIR = "embeddings_data"
os.makedirs(EMBEDDINGS_DIR, exist_ok=True)

EMBEDDINGS_FILE = os.path.join(EMBEDDINGS_DIR, "question_embeddings.npy")
METADATA_FILE = os.path.join(EMBEDDINGS_DIR, "metadata.pkl")
FAISS_INDEX_FILE = os.path.join(EMBEDDINGS_DIR, "faiss_index.idx")


def build_and_save_embeddings(knowledge_base):
    """ساخت و ذخیره امبدینگ‌ها و ایندکس FAISS"""
    print("در حال ساخت امبدینگ‌های جدید...")

    # بارگذاری مدل
    model = SentenceTransformer("myrkur/sentence-transformer-parsbert-fa-2.0")

    # آماده‌سازی داده‌ها
    all_questions = []
    metadata = []

    for item in knowledge_base:
        for q in item["questions"]:
            all_questions.append(q)
            metadata.append({
                "question": q,
                "answer": item["answer"],
                "intent_id": item.get("id") or item.get("intent_id", "")
            })

    # تولید امبدینگ‌ها
    question_embeddings = model.encode(all_questions, convert_to_numpy=True)

    # ذخیره امبدینگ‌ها
    np.save(EMBEDDINGS_FILE, question_embeddings)
    pd.to_pickle(metadata, METADATA_FILE)

    # ایجاد و ذخیره ایندکس FAISS
    dimension = question_embeddings.shape[1]
    index = faiss.IndexFlatL2(dimension)
    index.add(question_embeddings.astype('float32'))
    faiss.write_index(index, FAISS_INDEX_FILE)

    print(f"امبدینگ‌ها با موفقیت در پوشه '{EMBEDDINGS_DIR}' ذخیره شدند")


if __name__ == "__main__":
    knowledge_base = [
        {
            "id": "missing_organization",
            "questions": [
                "چرا نام سازمان یا واحد من در لیست کشویی انتخاب وجود ندارد؟",
                "اسم اداره ما تو لیست کشویی نیست، چکار کنم؟",
                "واحد ما توی فرم وجود نداره، باید چیکار کنم؟",
                "نام کارفرما رو نمی‌بینم، چجوری اضافه‌ش کنم؟"
            ],
            "answer": "لطفاً نام سازمان یا واحد مربوطه را به اداره فناوری اطلاعات و ارتباطات ارسال کنید تا بررسی و اضافه شود."
        },
        {
            "intent_id": "track_registered_leave",
            "questions": [
                "چطور می‌توانم مرخصی‌هایی که ثبت کرده‌ام را پیگیری کنم؟",
                "چطور بفهمم مرخصی‌هام تایید شده یا نه؟",
                "از کجا پیگیری کنم که مرخصی من بررسی شده؟",
                "برای پیگیری مرخصی‌های ثبت‌شده به کجا بروم؟"
            ],
            "answer": "برای پیگیری مرخصی‌های ثبت‌شده، وارد بخش «پیشخوان آرشیوها» شوید و سپس گزینه «مرخصی‌های شخصی» را انتخاب کنید. در این بخش می‌توانید گزارش پیگیری مرخصی‌های خود را مشاهده نمایید. برای اطلاعات بیشتر می‌توانید به فایل سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 3 مراجعه کنید."
        },
        {
            "intent_id": "view_leave_status",
            "questions": [
                "برای دیدن وضعیت مرخصی‌های خودم باید از کدام قسمت نرم‌افزار استفاده کنم؟",
                "وضعیت مرخصی‌هام رو از کجا ببینم؟",
                "برای دیدن تایید یا رد شدن مرخصی کجا برم؟",
                "از چه بخشی میشه لیست مرخصی‌های قبلی رو دید؟"
            ],
            "answer": "برای مشاهده وضعیت مرخصی‌ها، از منوی «پیشخوان آرشیوها» وارد بخش «مرخصی‌های شخصی» شوید. در این قسمت گزارش مرخصی‌های ثبت‌شده قابل مشاهده است. برای اطلاعات بیشتر می‌توانید به فایل سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 3 مراجعه کنید."
        },
        {
            "intent_id": "track_remote_or_mission",
            "questions": [
                "آیا امکان پیگیری مرخصی، ماموریت یا دورکاری از داخل سیستم وجود دارد؟",
                "چطور میشه ماموریت یا دورکاری ثبت‌شده رو پیگیری کرد؟",
                "می‌تونم از داخل سیستم پیگیری کنم که ماموریتم تایید شده؟",
                "برای دیدن وضعیت ماموریت یا دورکاری به کجا برم؟"
            ],
            "answer": "بله، شما می‌توانید مرخصی، ماموریت یا دورکاری‌های ثبت‌شده خود را از طریق منوی «پیشخوان آرشیوها» و بخش «مرخصی‌های شخصی» پیگیری کنید. برای اطلاعات بیشتر می‌توانید به فایل سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 3 مراجعه کنید."
        },
        {
            "intent_id": "detailed_tracking_tree",
            "questions": [
                "چگونه می‌توانم مرخصی، ماموریت یا دورکاری‌های ثبت‌شده را به صورت درختی و با جزئیات پیگیری کنم؟",
                "آیا مسیر تایید مرخصی یا ماموریت به شکل درختی نمایش داده میشه؟",
                "چطور ریز مراحل تایید مرخصی یا ماموریتم رو ببینم؟",
                "کجا می‌تونم پیگیری کامل مرخصی و ماموریت‌ها رو مشاهده کنم؟"
            ],
            "answer": "برای پیگیری جزئیات مرخصی‌ها، ماموریت‌ها یا دورکاری‌های خود به شکل درختی، به بخش «پیشخوان آرشیوها» بروید و سپس وارد «مرخصی‌های شخصی» شوید. در این بخش، گزارش و نمایش درختی فرآیند پیگیری درخواست‌ها قابل مشاهده است. برای اطلاعات بیشتر می‌توانید به فایل سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 3 مراجعه کنید."
        },
        {
            "id": "form_or_process_issue",
            "questions": [
                "هنگام کار با سامانه با خطایی مواجه شدم که نمی‌دانم باید چه کاری انجام دهم.",
                "فرآیند انجام کار رو بلد نیستم، چکار کنم؟",
                "نمی‌دونم فرم رو چطور پر کنم.",
                "در تکمیل فرم به مشکل برخوردم، راهنمایی می‌خوام.",
                "با اروری مواجه شدم ولی دلیلش رو نمی‌فهمم.",
                "فرآیند سیستم برای من واضح نیست، راهنمایی لازم دارم.",
                "نمی‌دونم چطور باید این کار رو در سامانه انجام بدم.",
                "در استفاده از فرم یا فرآیند دچار مشکل شدم، باید چکار کنم؟",
                "سامانه ارور می‌ده و نمی‌دونم دلیلش چیه.",
                "تو مراحل انجام فرآیند گیج شدم."
            ],
            "answer": "لطفاً راهنمای فرآیند مربوطه را با دقت مطالعه کنید. در بسیاری از موارد پاسخ مشکل شما در راهنما وجود دارد."
        },
        {
            "id": "missing_organization",
            "questions": [
                "چرا نام سازمان یا واحد من در لیست کشویی انتخاب وجود ندارد؟",
                "اسم اداره ما تو لیست کشویی نیست، چکار کنم؟",
                "واحد ما توی فرم وجود نداره، باید چیکار کنم؟",

                "نام کارفرما رو نمی‌بینم، چجوری اضافه‌ش کنم؟",
                "لیست سازمان‌ها ناقصه و اسم ما داخلش نیست.",
                "نمی‌تونم اسم واحد خودمون رو در لیست کشویی پیدا کنم.",
                "سازمان ما توی گزینه‌های انتخابی نیست.",
                "توی فرم، نام شرکت یا کارفرما نیست.",
                "اسم بخش ما در فرم وجود نداره.",
                "واحد انجام‌دهنده ما توی لیست نیست، باید چیکار کرد؟"
            ],
            "answer": "لطفاً نام سازمان یا واحد مربوطه را به اداره فناوری اطلاعات و ارتباطات ارسال کنید تا بررسی و اضافه شود."
        },
        {
            "id": "change_actor",
            "questions": [
                "آیا می‌توانم اقدام‌کننده یک فعالیت را تغییر دهم؟",
                "میشه اقدام‌کننده رو عوض کرد؟",
                "چطور اقدام‌کننده یک کار رو تغییر بدم؟",
                "می‌تونم کسی دیگه‌ای رو جای خودم اقدام‌کننده کنم؟",
                "امکان تغییر شخص اقدام‌کننده وجود داره؟",
                "می‌خوام اقدام‌کننده فعالیت رو تغییر بدم، می‌شه؟",
                "نقش اقدام‌کننده رو چطور تغییر بدم؟",
                "می‌خوام اقدام‌کننده‌ی پروژه رو عوض کنم.",
                "آیا امکان تغییر مسئول اقدام در سیستم هست؟"
            ],
            "answer": "خیر، امکان تغییر اقدام‌کننده برای فعالیت وجود ندارد."
        },
        {
            "id": "missing_project_code",
            "questions": [
                "چرا عنوان پیشنهاد یا کد مالی پروژه من در فهرست ابتدایی فرآیند نمایش داده نمی‌شود؟",
                "پروژه من توی لیست شروع فرآیند نیست، باید چکار کنم؟",
                "کد مالی پروژه‌ام در ابتدای فرآیند دیده نمی‌شود.",
                "نمی‌تونم پروژه‌ام رو برای شروع فرآیند انتخاب کنم.",
                "پروژه‌ای که دنبالشم در لیست اولیه وجود نداره.",
                "کد پروژه در لیست جستجوی اولیه نیست.",
                "لیست پروژه‌ها ناقصه و کدی که می‌خوام نیست.",
                "توی سامانه، کد مالی پیشنهادم پیدا نمی‌شه.",
                "چرا کد پروژه‌ام برای شروع فرآیند بالا نمیاد؟"
            ],
            "answer": "لطفاً مشکل را از طریق ثبت تیکت در سامانه سپهر گزارش کنید تا بررسی شود."
        },
        {
            "id": "invalid_input_format",
            "questions": [
                "هنگام پر کردن فرم با خطای \"عدم همخوانی داده‌های ورودی با فرمت تعریف شده\" مواجه می‌شوم، باید چه کنم؟",
                "داده‌هایی که وارد می‌کنم با فرمت فرم مطابقت نداره.",
                "خطای فرمت اشتباه هنگام ثبت اطلاعات گرفتم.",
                "فرم ارور می‌ده که ورودی با فرمت مطابقت نداره.",
                "نمی‌دونم چرا خطای فرمت داده دریافت می‌کنم.",
                "همه چیزو درست زدم ولی فرم قبول نمی‌کنه.",
                "ارور مربوط به قالب اطلاعات گرفتم.",
                "اطلاعات رو درست وارد کردم ولی فرم خطا می‌ده.",
                "خطایی در پر کردن فرم گرفتم که نمی‌فهمم منظورش چیه.",
                "ورودی‌هام خطای قالب دارن، باید چکار کنم؟"
            ],
            "answer": "لطفاً یک تیکت در سامانه سپهر ثبت کنید تا کارشناسان فنی مشکل را بررسی و راهنمایی کنند."
        },
        {
            "id": "print_issue",
            "questions": [
                "نمی‌توانم نسخه چاپی دریافت کنم، باید چه کار کنم؟",
                "چاپ نمی‌گیره، خطا می‌ده.",
                "نمی‌تونم فرم رو پرینت بگیرم.",
                "گزینه چاپ کار نمی‌کنه.",
                "هنگام گرفتن پرینت مشکلی پیش میاد.",
                "نسخه چاپی تولید نمی‌شه.",
                "مشکل در خروجی گرفتن چاپ دارم.",
                "فرم چاپ نمی‌شه یا اجرا نمی‌گیره.",
                "برای پرینت گرفتن به مشکل خوردم.",
                "وقتی روی چاپ می‌زنم، چیزی نمیاد."
            ],
            "answer": "لطفاً یک تیکت در سامانه سپهر ثبت کنید تا مشکل بررسی شود و راهکار مناسب ارائه گردد."
        },
        {
            "intent_id": "leave_section_not_visible",
            "questions": [
                "چرا بخش ثبت مرخصی‌های اتوماتیک برای من نمایش داده نمی‌شود؟",
                "بخش مربوط به مرخصی اتوماتیک باز نمی‌شود، مشکل چیه؟",
                "قسمت ثبت مرخصی اتوماتیک برای من نمیاد، باید چیکار کنم؟",
                "چرا گزینه ثبت مرخصی‌های خودکار در سیستم نیست؟"
            ],
            "answer": "اگر بخش ثبت مرخصی‌های اتوماتیک را نمی‌بینید، لازم است برای بررسی و رفع مشکل با راهبر سیستم تماس بگیرید. برای اطلاعات بیشتر به سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 6 مراجعه کنید."
        },
        {
            "intent_id": "how_to_fill_leave_form",
            "questions": [
                "چطور فرم مرخصی رو تکمیل کنم؟",
                "نحوه پر کردن فرم ثبت مرخصی به چه صورت است؟",
                "برای ثبت مرخصی روزانه یا ساعتی چه فیلدهایی رو باید پر کنم؟",
                "در فرم مرخصی، نوع مرخصی را از کجا انتخاب کنم؟"
            ],

            "answer": "برای تکمیل فرم مرخصی، ابتدا نوع مرخصی را از منوی کشویی انتخاب کنید (مثلاً ساعتی یا روزانه) و سپس سایر فیلدهای موردنیاز مثل تاریخ، ساعت و توضیحات را وارد کنید. برای اطلاعات بیشتر به سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 6 مراجعه کنید."
        },
        {
            "intent_id": "epm_report_access",
            "questions": [
                "چطور می‌تونم گزارش EPM را در سیستم ببینم؟",
                "گزارش عملکرد روزانه یا EPM را از کجا باید باز کنم؟",
                "مسیر دسترسی به گزارش‌های EPM در نرم‌افزار کجاست؟",
                "برای دیدن عملکرد شخصی بر اساس روز باید از چه منویی استفاده کنم؟"
            ],
            "answer": "برای مشاهده گزارش EPM، وارد سامانه شوید و از منوی پیشخوان، گزینه «گزارش‌ها» و سپس «عملکرد شخصی بر اساس روز» را انتخاب نمایید. برای اطلاعات بیشتر به سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 7 مراجعه کنید."
        },
        {
            "intent_id": "manual_mission_submission",
            "questions": [
                "چطور می‌تونم ماموریت ساعتی یا دورکاری رو دستی ثبت کنم؟",
                "آیا میشه ماموریت‌های ساعتی یا دورکاری رو از طریق ثبت درخواست دستی وارد کرد؟",
                "نحوه ثبت ماموریت غیرروزانه به صورت دستی چطوره؟",
                "آیا همه ماموریت‌ها باید از مسیر دستی ثبت بشن؟"
            ],
            "answer": "فقط ماموریت‌های روزانه از طریق ثبت درخواست دستی قابل ثبت و ارسال برای تأیید هستند. سایر درخواست‌های ماموریت یا دورکاری باید طبق پروتکل از مسیر ماموریت یا مرخصی اتوماتیک ثبت شوند. برای اطلاعات بیشتر به سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 7 مراجعه کنید."
        },
        {
            "intent_id": "part_time_user_restriction",
            "questions": [
                "چرا نمی‌تونم از نرم‌افزار تردد استفاده کنم؟",
                "برای همکاران پاره وقت امکان استفاده از سامانه تردد وجود داره؟",
                "آیا افراد پاره‌وقت هم باید از نرم‌افزار چارگون استفاده کنن؟",
                "چرا سیستم تردد برای من فعال نیست؟ من پاره‌وقت هستم."
            ],
            "answer": "سامانه تردد چارگون مخصوص همکاران تمام‌وقت پژوهشگاه طراحی شده است. همکاران پاره‌وقت باید از سامانه کسرا جهت ثبت درخواست‌های خود استفاده کنند. برای اطلاعات بیشتر به سؤالات متداول کاربران درمورد نرم‌افزار تردد صفحه 8 مراجعه کنید."
        }
    ]

    build_and_save_embeddings(knowledge_base)