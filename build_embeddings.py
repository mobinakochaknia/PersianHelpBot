# -*- coding: utf-8 -*-
import os
import pandas as pd
import numpy as np
import faiss
from sentence_transformers import SentenceTransformer
from utils_normalize import normalize_fa 

# تنظیمات مسیرها
EMBEDDINGS_DIR = "embeddings_data"
os.makedirs(EMBEDDINGS_DIR, exist_ok=True)

EMBEDDINGS_FILE = os.path.join(EMBEDDINGS_DIR, "question_embeddings.npy")
METADATA_FILE = os.path.join(EMBEDDINGS_DIR, "metadata.pkl")
FAISS_INDEX_FILE = os.path.join(EMBEDDINGS_DIR, "faiss_index_ip.idx")  # ⬅️ IP

MODEL_NAME = "myrkur/sentence-transformer-parsbert-fa-2.0"

def build_and_save_embeddings(knowledge_base):
    """ساخت و ذخیره امبدینگ‌ها و ایندکس FAISS (نرمال + IP)"""
    print("در حال ساخت امبدینگ‌های جدید...")

    # بارگذاری مدل
    model = SentenceTransformer(MODEL_NAME)

    # آماده‌سازی داده‌ها
    all_questions = []
    metadata_rows = []

    for item in knowledge_base:
        for q in item["questions"]:
            all_questions.append(q)
            metadata_rows.append({
                "question": q,
                "answer": item["answer"],
                "intent_id": item.get("id") or item.get("intent_id", "")
            })

    # تولید امبدینگ‌ها (np.float32 + نرمال‌سازی واحد)
    question_embeddings = model.encode(
        all_questions,
        convert_to_numpy=True,
        normalize_embeddings=True  # ⬅️ بسیار مهم
    ).astype("float32")

    # (اختیاری ولی بی‌ضرر) دوباره نرمال‌سازی با FAISS برای اطمینان
    faiss.normalize_L2(question_embeddings)

    np.save(EMBEDDINGS_FILE, question_embeddings)

    # بهتره DataFrame ذخیره کنی تا iloc راحت‌تر باشه
    metadata_df = pd.DataFrame(metadata_rows)

    # ⬅️ ستون نرمال‌شده برای بهبود فازی/BM25
    metadata_df["question_norm"] = metadata_df["question"].astype(str).apply(normalize_fa)

    pd.to_pickle(metadata_df, METADATA_FILE)

    # ساخت ایندکس IP (cosine وقتی بردارها unit-norm هستند)
    dim = question_embeddings.shape[1]
    index = faiss.IndexFlatIP(dim)
    index.add(question_embeddings)  # امبدینگ‌های واحد-نرمال
    faiss.write_index(index, FAISS_INDEX_FILE)

    print(f"✅ امبدینگ‌ها و ایندکس IP با موفقیت در '{EMBEDDINGS_DIR}' ذخیره شدند.")

if __name__ == "__main__":
    knowledge_base = [
    {
        "intent_id": "track_registered_leave",
        "questions": [
            "به چه صورت می‌شود مرخصی‌هایی که ثبت کرده‌ام را بررسی کنم؟",
            "به چه صورت بفهمم مرخصی‌هام تأیید شده یا نه؟",
            "از از کدام بخش بررسی کنم که مرخصی من بررسی شده؟",
            "برای بررسی مرخصی‌های ثبت شده به از کدام بخش بروم؟"
        ],
         "answer": "برای پیگیری ماموریت ها، وارد بخش «پیشخوان آرشیوها» شوید و سپس گزینه «آرشیو ماموریت های شخصی» را انتخاب کنید. ماموریت مورد نظر را انتخاب کرده و روی گزینه مشاهده کلیک کنید و سپس میتوانید وضعیت آن را در درخت پیگیری مشاهده کنید. برای اطلاعات بیشتر می‌توانید به لینک زیر مشاهده کنید:\nhttps://drive.google.com/file/d/1PJ6jSuyGv4xEBPrxGVyXT18601P2iex3/view?usp=drive_link"
    },
    {
        "intent_id": "view_leave_status",
        "questions": [
            "برای دیدن وضعیت ماموریت خودم باید از کدام قسمت نرم‌افزار استفاده کنم؟",
            "وضعیت ماموریت رو از از کدام بخش مشاهده کنم؟",
            "برای دیدن تأیید یا رد شدن ماموریت از کدام بخش برم؟",
            "از چه بخشی میشه لیست ماموریت های قبلی رو دید؟"
        ],
        
        "answer": "برای پیگیری ماموریت ها، وارد بخش «پیشخوان آرشیوها» شوید و سپس گزینه «آرشیو ماموریت های شخصی» را انتخاب کنید. ماموریت مورد نظر را انتخاب کرده و روی گزینه مشاهده کلیک کنید و سپس میتوانید وضعیت آن را در درخت پیگیری مشاهده کنید. برای اطلاعات بیشتر می‌توانید به لینک زیر مشاهده کنید:\nhttps://drive.google.com/file/d/1PJ6jSuyGv4xEBPrxGVyXT18601P2iex3/view?usp=drive_link"

    },
    {
        "intent_id": "access_bpms",
        "questions": [
            "به چه صورت  می‌توان به کارتابل BPMS دسترسی پیدا کرد؟"
        ],
        "answer": "ابتدا از قسمت شروع، سپس دیدگاه من(نرم افزارها)  قسمت مدیریت  فرآیندها کسب و کار >> عملیات >>کارتابل  BPMS میتوان دسترسی پیدا کرد ."
    },
    {
        "intent_id": "bpms_process_error",
        "questions": [
            "هنگام انتخاب فرآیند در کارتابل BPMS پیام خطای process executing Error برای چیست؟"
        ],
        "answer": "مشاهده این اررور به این دلیل است که هنگامی که کارتابل BPMS را باز می‌کنیم و سمت پایه انتخاب نمی‌کنیم، فرآیند اجرا نمی‌شود و با نمایش خطای process executing Error مواجه می‌شویم. برای رو به رو نشدن با این خطا باید ابتدا پس از باز کردن کارتابل BPMS اول سمت پیش فرض را انتخاب نمود بعد فرآیند مورد نظر را انتخاب کنید."
    },
    {
        "intent_id": "process_edit_contact_admin",
        "questions": [
            "چرا هنگام دریافت اصلاحات در ساختار شکست فرآیند با زدن دکمه تکمیل ، پیام می دهد که با راهبر تماس گرفته شود؟"
        ],
        "answer": "در این شرایط باید دکمه ویرایش را کلیک کرده و اصلاحات مورد نظر در هر ردیف جدول را انجام شود. لازم به ذکر است هیچ ردیفی از جدول‌ها نباید حذف بشود. فقط با ویرایش کردن تمام اطلاعات مورد نظرتان را ویرایش کنید."
    },
    {
        "intent_id": "bpms_complete_disabled",
        "questions": [
            "چرا پس از دریافت اعلان انجام  فعالیت ها از کارتابل BPMS و انجام تکمیل فرآیند ، فرآیند تکمیل نمی‌شود یعنی دکمه تکمیل همچنان غیر فعال است؟"
        ],
        "answer": "اعلان به منظور آگاهی دادن از انجام فرآیند می‌باشد که حتما باید کارتابل در BPMS باز شده باشد و سمت انتخاب شده و در قسمت فعالیت‌های من فرآیند جدید را تکمیل نماییم."
    },
    {
        "intent_id": "internal_letter_indicator",
        "questions": [
            "چرا برای ثبت نامه داخلی بعد از انتخاب فیلد های ستاره دار و ایجاد نامه جایگذاری ، مشخصات نامه کار نمی‌کند؟"
        ],
        "answer": "انتخاب نکردن اندیکاتور منجر به چنین مشکلی می‌شود، بعد از سال جدید شمسی باید اندیکاتور را تنظیم کرده. لیست کشویی اندیکاتور را باز کرده و داخلی سال جاری را انتخاب می‌کنیم."
    },
    {
        "intent_id": "employment_certificate_error",
        "questions": [
            "چرا برای گرفتن گواهی اشتغال به کار با خطا روبه رو می‌ شویم؟"
        ],
        "answer": "اکثر افراد ممکن است دارای چندین سمت باشند، باید در قسمت نوار سمت راست، بر روی تنظیمات رفته و سمت خود را بر روی سمت قبلی قرار داده و از قسمت پایین ذخیره را زده و سپس خروج از اتوماسیون را بزنیم و دوباره وارد اتوماسیون شده و با حالت سمت پیش فرض درخواست گواهی اشتغال به کار را زده و دیگر مشکل برطرف شده است."
    },
    {
        "intent_id": "project_contract_error",
        "questions": [
            "در هنگام تهیه قرارداد پروژه ای پس از تکمیل اطلاعات و در نهایت ثبت آن فرآیند، ثبت نمی‌شود و مدت زمان طولانی در حال چرخش می‌باشد، دلیل آن چیست؟",
            "قرارداد پروژه ای موقع ثبت خطا می‌دهد، به چه صورت رفع اشکال کنیم؟"
        ],
        "answer": "کپی کردن اطلاعات عددی و پیست کردن آن در فیلدهای مورد نظر است. برای جلوگیری از این خطا باید اعداد مانند نفرماه، جمع نفرماه و ... در فیلدهای مورد نظر دستی تایپ شوند."
    },
    {
        "intent_id": "search_old_docs",
        "questions": [
            "نامه هایی که تاریخ آنها از سه ماه بیشتر گذشته است به چه صورت جستجو کنیم؟",
            "پیام هایی که تاریخ آنها از سه ماه بیشتر گذشته است به چه صورت جستجو کنیم؟",
            "پیش نویس هایی  که تاریخ آنها از سه ماه بیشتر گذشته است به چه صورت جستجو کنیم؟"
        ],
        "answer": "از صفحه کارتابل کنار نوار جستجو جدول کوچکی (آرشیوهای شخصی) وجود دارد روی آن کلیک کرده و 3 گزینه آرشیو نامه‌های شخصی، آرشیو پیش‌نویس‌های شخصی و آرشیو پیام‌های شخصی نمایش داده می‌شود. در صفحه نمایش داده شده شما می‌توانید با وارد کردن هر کدام از فیلدهای مورد نظر جستجوی خود را انجام دهید."
    },
    {
        "intent_id": "external_recipient",
        "questions": [
            "زمان ارسال نامه درصورت نبودن نام شخص در لیست گیرندگان نامه ، به چه صورت  می توان شخص گیرنده را تعیین کرد؟"
        ],
        "answer": "از طریق ارسال پیام به مسئول دبیرخانه با عنوان گیرندگان خارجی، نام و سمت شخص گیرنده را ارسال نمایید تا به لیست اضافه شود."
    },
    {
        "intent_id": "asset_transfer_form",
        "questions": [
            "نحوه پر نمودن فرم جا به جایی اموال به چه صورت است؟"
        ],
        "answer": "از قسمت میزکار، ارسال پیش‌نویس را انتخاب نموده و گیرنده و پیش‌نویس (تحویل گیرنده اموال می‌باشد) و امضا کننده نهایی و اصل امین اموال (جناب آقای خاکزاد) می‌باشد، موضوع را انتخاب کرده و در قسمت انتخاب الگو، الگوی نامه جابه‌جایی اموال را انتخاب می‌کنیم."
    },
    {
        "intent_id": "signature_missing_draft",
        "questions": [
            "در هنگام تهیه پیش نویس علامت امضا دیده نمیشود ؟"
        ],
        "answer": "این مشکل به این دلیل است که در هنگام تایپ متن Enter و فاصله‌های طولانی وجود دارد و الگوی نامه جابه‌جا شده است. برای حل این مشکل الگوی جدیدی را انتخاب نمایید."
    },
    {
        "intent_id": "personal_reminder",
        "questions": [
            "به چه صورت میتوانم یاداوری شخصی ایجاد کنم ؟"
        ],
        "answer": "از نوار تیره رنگ سمت راست میزکار آیکون زنگوله پایین را انتخاب کرده و در این قسمت با کلیک بر روی درج یادآور جدید می‌توانید برای خود اعلان ایجاد کنید."
    },
    {
        "intent_id": "personal_groups",
        "questions": [
            "به چه صورت گروه های شخصی ایجاد کنم ؟"
        ],
        "answer": "در کارتابل پایین صفحه بر روی قسمت آدمک کلیک کرده، گزینه تنظیمات شخصی را انتخاب کنید. صفحه‌ای با عنوان تنظیمات شخصی باز می‌شود. در این قسمت در بخش گروه‌های شخصی جهت ایجاد گروه کارمندی شخصی برای ارسال نامه و گروه‌های کاربری شخصی جهت ارسال پیام اقدام کنید."
    },
    {
        "intent_id": "access_automation",
        "questions": [
            "از چه طریقی میتوان به اتوماسیون دسترسی پیدا کرد ؟"
        ],
        "answer": "پیشنهاد می‌شود از مرورگر Chrome استفاده شود و آدرس https://oa.nri.ac.ir در نوار جستجو تایپ گردد."
    },
    {
        "intent_id": "access_sepehr",
        "questions": [
            "به چه صورت میتوان به سامانه سپهر جهت ارسال تیکت دسترسی پیدا کرد ؟"
        ],
        "answer": "پیشنهاد می‌شود از مرورگر Chrome استفاده شود و آدرس https://sepehr.nri.ac.it در نوار جستجو تایپ گردد."
    },
    {
        "intent_id": "reply_received_letter",
        "questions": [
            "به چه صورت میتوان نامه دریافت شده را پاسخ داد ؟"
        ],
        "answer": "برای این کار چند راه وجود دارد. می‌توانید نامه را ارجاع دهید: کنار نامه روی سه نقطه کلیک کرده، گزینه ارجاع را انتخاب کنید یا نامه را باز کرده و در تب بالا ارجاع را انتخاب کنید. سپس از تب کارمند شخص مورد نظر را انتخاب کرده و در قسمت شرح پاسخ خود را بنویسید. اگر نیاز به فایل پیوست داشت، آن را انتخاب کرده و پس از انتخاب فایل، گیرندگان نامه را به صورت اصل، رونوشت یا رونوشت مخفی انتخاب کنید و در انتها گزینه ارجاع را بزنید. توجه شود تمام مراحل ارجاع باید به ترتیب انجام شود. راه دیگر تهیه پاسخ است: از سه نقطه کنار نامه می‌توانید گزینه تهیه پاسخ را انتخاب کرده، فیلدها را پر کرده و نامه خود را پاسخ دهید."
    }
]
    build_and_save_embeddings(knowledge_base)
